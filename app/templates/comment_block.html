<!-- Comment Container -->
<div class="comment-container mb-4" id="comment-{{ comment.id }}">
    <!-- Comment Header -->
    <div class="d-flex mb-2">
        {% set img_size = 30 if comment.get_depth() > 0 else 40 %}
        <img src="{{ url_for('static', filename='profile_pics/' + comment.author.profile_picture) }}" 
             alt="{{ comment.author.full_name }}" 
             class="rounded-circle me-2" 
             style="width: {{ img_size }}px; height: {{ img_size }}px; object-fit: cover;">
        <div>
            <h6 class="mb-0">
                <a href="{{ url_for('users.user_posts', username=comment.author.username) }}">{{ comment.author.full_name }}</a>
                {% if comment.author.role == 'admin' %}
                    <span class="badge bg-danger">Admin</span>
                {% endif %}
            </h6>
            <small class="text-muted">{{ comment.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
        </div>
    </div>
    
    <!-- Comment Content -->
    {% set content_class = "ms-4" if comment.get_depth() > 0 else "ms-5" %}
    {% set font_style = "font-size: 0.95rem;" if comment.get_depth() > 0 else "" %}
    <div class="comment-content {{ content_class }} mb-2" style="{{ font_style }}" id="comment-content-{{ comment.id }}">
        {{ comment.content|safe }}
    </div>
    
    <script>
        // Apply syntax highlighting to code blocks in this comment
        document.addEventListener('DOMContentLoaded', function() {
            const commentContent = document.getElementById('comment-content-{{ comment.id }}');
            if (commentContent) {
                commentContent.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            }
        });
    </script>
    
    <!-- Comment Actions -->
    <div class="comment-actions {{ content_class }}">
        <button class="btn btn-sm btn-link text-primary p-0 reply-button" data-comment-id="{{ comment.id }}">Reply</button>
        
        {% if comment.replies.count() > 0 %}
            <button class="btn btn-sm btn-link text-secondary p-0 ms-2 toggle-replies" data-comment-id="{{ comment.id }}">
                <i class="fas fa-caret-down me-1"></i>Hide Replies
            </button>
        {% endif %}
        
        {% if current_user.is_authenticated and (current_user == comment.author or current_user.is_admin()) %}
            <form action="{{ url_for('posts.delete_comment', comment_id=comment.id) }}" method="POST" class="d-inline delete-comment-form">
                {% set comment_type = "reply" if comment.get_depth() > 0 else "comment" %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2 delete-comment-btn" 
                       data-comment-id="{{ comment.id }}" data-comment-type="{{ comment_type }}">
                    Delete
                </button>
            </form>
        {% endif %}
    </div>
    
    <!-- Reply Form (hidden by default) -->
    <div class="reply-form {{ content_class }} mt-2" id="reply-form-{{ comment.id }}" style="display: none;">
        {% if current_user.is_authenticated %}
            <form method="POST" action="{{ url_for('posts.reply_to_comment', comment_id=comment.id) }}" class="reply-form-element" id="reply-form-element-{{ comment.id }}" data-comment-id="{{ comment.id }}">
                {{ reply_form.hidden_tag() }}
                {{ reply_form.parent_id(value=comment.id) }}
                <div class="mb-3">
                    <textarea id="reply-{{ comment.id }}" name="content"></textarea>
                </div>
                <div class="mb-3">
                    <button type="submit" class="btn btn-sm btn-primary">Reply</button>
                    <button type="button" class="btn btn-sm btn-secondary cancel-reply" data-comment-id="{{ comment.id }}">Cancel</button>
                </div>
            </form>
        {% else %}
            <div class="alert alert-info">
                Please <a href="{{ url_for('auth.login', next=request.path) }}">log in</a> to reply.
            </div>
        {% endif %}
    </div>
    
    <!-- Replies Container -->
    {% if comment.replies.count() > 0 %}
        <div class="replies {{ content_class }} mt-3" id="replies-{{ comment.id }}">
            {% for reply in comment.replies %}
                {% with comment=reply %}
                    {% include "comment_block.html" %}
                {% endwith %}
            {% endfor %}
        </div>
    {% endif %}
</div> 